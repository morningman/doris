#!/bin/bash
# input:  result.csv(generated by run.sh), run.log(generated by benchmark.sh)
# output:
#
# Doris version:  opt_perf-06e646a551-release-20220926190600
# Relative time(to total, geometric mean of column ratio_of_total):       3.2547578782968904
# Relative time(to machine, geometric mean of column ratio_of_machine):   1.3197387183010671
# load time:      556 seconds
# storage size:   17122689302 bytes (15.946 GB)
# mechine:        Amazon EC2, c6a.4xlarge
# column best:                    best of hot1 and hot2
# column total_baseline:          data from https://benchmark.clickhouse.com/
# column ratio_of_total:          (best+0.01)/(total_baseline+0.01)
# column machine_baseline:        data from https://benchmark.clickhouse.com/, mechine is c6a.4xlarge,500gb gp2
# column ratio_of_machine:        (best+0.01)/(machine_baseline+0.01)

# query   cold    hot1    hot2    best    total_baseline  ratio_of_total  machine_baseline        ratio_of_machine
# query1  0.01    0.01    0.01    0.01    0.000155000     1.969473166     0.000155000     1.969473166
# query2  0.08    0.03    0.02    0.02    0.010000000     1.500000000     0.010000000     1.500000000
# query3  0.10    0.05    0.05    0.05    0.010000000     3.000000000     0.033000000     1.395348837
# query4  1.04    1.05    0.04    0.04    0.010000000     2.500000000     0.029207000     1.275282475
# query5  0.33    0.32    0.32    0.32    0.109031000     2.772387025     0.620000000     0.523809524
# query6  0.76    0.66    0.67    0.66    0.176052000     3.601143766     0.930000000     0.712765957
# query7  0.01    0.02    0.01    0.01    0.010000000     1.000000000     0.024000000     0.588235294
# query8  0.03    0.03    0.03    0.03    0.010000000     2.000000000     0.015000000     1.600000000
# query9  0.39    0.35    0.35    0.35    0.133104000     2.515652952     0.580000000     0.610169492
# query10 0.45    0.45    0.45    0.45    0.284000000     1.564625850     0.680000000     0.666666667
# query11 0.11    0.08    0.08    0.08    0.088729000     0.911586261     0.090000000     0.900000000
# query12 0.12    0.09    0.08    0.08    0.080000000     1.000000000     0.090000000     0.900000000
# query13 0.55    0.58    0.59    0.58    0.158393000     3.503708586     0.294000000     1.940789474
# query14 0.77    0.83    0.95    0.83    0.213000000     3.766816143     1.029000000     0.808469682
# query15 0.86    0.86    0.82    0.82    0.174000000     4.510869565     0.897000000     0.915104741
# query16 0.38    0.38    0.36    0.36    0.143406000     2.411900447     0.550000000     0.660714286
# query17 1.27    1.22    1.26    1.22    0.339775000     3.516546351     2.350000000     0.521186441
# query18 0.38    0.27    0.34    0.27    0.275000000     0.982456140     0.370000000     0.736842105
# query19 2.67    2.34    2.42    2.34    0.506000000     4.554263566     4.380000000     0.535307517
# query20 0.02    0.02    0.02    0.02    0.000157442     2.953499513     0.000157442     2.953499513
# query21 10.53   1.17    2.13    1.17    0.070000000     14.750000000    0.070000000     14.750000000
# query22 8.92    2.91    0.96    0.96    0.140000000     6.466666667     0.395884000     2.389845375
# query23 11.80   1.41    1.06    1.06    0.310000000     3.343750000     0.395477000     2.638867309
# query24 31.70   2.83    2.67    2.67    0.046760200     47.216183171    0.335000000     7.768115942
# query25 1.27    0.19    0.20    0.19    0.002459360     16.052188876    0.005000000     13.333333333
# query26 0.18    0.17    0.17    0.17    0.045000000     3.272727273     0.130000000     1.285714286
# query27 0.19    0.19    0.18    0.18    0.058000000     2.794117647     0.139861000     1.267841533
# query28 10.51   1.50    1.23    1.23    0.130000000     8.857142857     0.733000000     1.668909825
# query29 8.59    3.37    3.28    3.28    0.483000000     6.673427992     5.570000000     0.589605735
# query30 0.69    1.06    0.67    0.67    0.203014000     3.192278442     0.713598326     0.939747890
# query31 1.79    0.44    0.44    0.44    0.113000000     3.658536585     0.520000000     0.849056604
# query32 2.13    0.52    0.51    0.51    0.175000000     2.810810811     0.712000000     0.720221607
# query33 3.25    3.32    3.29    3.29    0.048000000     56.896551724    4.820000000     0.683229814
# query34 11.70   4.71    4.40    4.40    0.494000000     8.750000000     0.494000000     8.750000000
# query35 11.56   4.39    4.42    4.39    0.544000000     7.942238267     4.035000000     1.087762670
# query36 0.56    0.50    0.50    0.50    0.137629000     3.454605802     1.188000000     0.425709516
# query37 0.54    0.06    0.06    0.06    0.040539136     1.385065229     0.040539136     1.385065229
# query38 0.04    0.04    0.03    0.03    0.019683109     1.347567736     0.019683109     1.347567736
# query39 0.03    0.02    0.03    0.02    0.010000000     1.500000000     0.010000000     1.500000000
# query40 0.16    0.13    0.13    0.13    0.085472760     1.466386852     0.085472760     1.466386852
# query41 0.04    0.02    0.02    0.02    0.007633564     1.701300996     0.007633564     1.701300996
# query42 0.04    0.02    0.03    0.02    0.007858586     1.679864240     0.007858586     1.679864240
# query43 0.03    0.02    0.02    0.02    0.010000000     1.500000000     0.010000000     1.500000000
# total   126.58  38.63   35.3    33.95
# ---------------------------------------------------------------------------------------------------
#                                             System & Machine            Relative time (lower is better)

#                            ClickHouse (c6a.metal, 500gb gp2)            1.5760853706679743
#                                  Redshift (ra3.16xlarge x 4)            2.0879180352166737
#                               Doris (c6a.4xlarge, 500gb gp2)            3.1015376316015066
#                                         Snowflake (3XL x 64)            3.3995989147433177
#                                         Snowflake (2XL x 32)            3.5325765056367633
#                                        Snowflake (4XL x 128)            3.7563516229712417
#                                        Redshift (serverless)            3.8898942253616133
#                   StarRocks (tuned) (c6a.4xlarge, 500gb gp2)            4.108675586286408
#                                          Snowflake (XL x 16)            4.141568381465441
#                          ClickHouse (c6a.4xlarge, 500gb gp2)            4.292133099806719
#                   ClickHouse (zstd) (c6a.4xlarge, 500gb gp2)            4.542504121421901
#                                                ByteHouse (L)            4.5641878557769875
#                           StarRocks (c6a.4xlarge, 500gb gp2)            4.646699460996926
#                                   Redshift (ra3.4xlarge x 4)            4.675940145208558
#                                            Snowflake (L x 8)            5.453270103893935
#                                                ByteHouse (M)            7.11601019685313
#                                            Snowflake (M x 4)            7.462266835777707
#                                    Redshift (ra3.xlplus x 4)            8.382290484206486
#                                                ByteHouse (S)            9.115941357175748
#                                            Snowflake (S x 2)            10.443065820361104
#                                               Snowflake (XS)            15.205274397575339
#      clickhouse-local (partitioned) (c6a.4xlarge, 500gb gp2)            16.403730411992843
#                 QuestDB (partitioned) (c6a.metal, 500gb gp2)            22.96981740370837
#                                 Athena (single) (serverless)            29.519465802474702
#                           Greenplum (c6a.4xlarge, 500gb gp2)            31.88693549156935
#                            Athena (partitioned) (serverless)            33.29175294784786
#                             QuestDB (c6a.4xlarge, 500gb gp2)            41.04637944584361
#           clickhouse-local (single) (c6a.4xlarge, 500gb gp2)            57.25233113714717
#           TimescaleDB (compression) (c6a.4xlarge, 500gb gp2)            82.36956599222754
#                               Citus (c6a.4xlarge, 500gb gp2)            209.7326436492486
#                                Aurora for PostgreSQL (16acu)            362.8032370872752
#                         TimescaleDB (c6a.4xlarge, 500gb gp2)            807.961772263912
#                          PostgreSQL (c6a.4xlarge, 500gb gp2)            837.7332360758497
#                               MySQL (c6a.4xlarge, 500gb gp2)            2445.2833661877744


total_baseline=(0.000155 0.01 0.01 0.01 0.109031 0.176052 0.01 0.01 0.133104 0.284 0.088729 0.08 0.158393 0.213 0.174 0.143406 0.339775 0.275 0.506 0.000157442 0.07 0.14 0.31 0.0467602 0.00245936 0.045 0.058 0.13 0.483 0.203014 0.113 0.175 0.048 0.494 0.544 0.137629 0.040539136 0.019683109 0.01 0.08547276 0.007633564 0.007858586 0.01)

machine_baseline=(0.000155 0.01 0.033 0.029207 0.62 0.93 0.024 0.015 0.58 0.68 0.09 0.09 0.294 1.029 0.897 0.55 2.35 0.37 4.38 0.000157442 0.07 0.395884 0.395477 0.335 0.005 0.13 0.139861 0.733 5.57 0.713598326 0.52 0.712 4.82 0.494 4.035 1.188 0.040539136 0.019683109 0.01 0.08547276 0.007633564 0.007858586 0.01)

awk -F ',' '{if($3<$4){print $3}else{print $4}}' result.csv >best_hot.csv
i=0
product=1
while read -r doris; do
    r=$(echo "scale=9;(${doris} + 0.01) / (${total_baseline[$i]} + 0.01)" | bc)
    ((i++))
    product=$(echo "scale=9; $product * $r" | bc)
done <best_hot.csv
total_score=$(echo "print(pow($product, 1.0/43))" | python3)

i=0
product=1
while read -r doris; do
    r=$(echo "scale=9;(${doris} + 0.01) / (${machine_baseline[$i]} + 0.01)" | bc)
    ((i++))
    product=$(echo "scale=9; $product * $r" | bc)
done <best_hot.csv
machine_score=$(echo "print(pow($product, 1.0/43))" | python3)

total_cold=$(awk -F ',' '{sum+=$2} END {print sum}' result.csv)
total_hot1=$(awk -F ',' '{sum+=$3} END {print sum}' result.csv)
total_hot2=$(awk -F ',' '{sum+=$4} END {print sum}' result.csv)
total_best_hot=$(awk -F ',' '{if($3<$4){sum+=$3}else{sum+=$4}} END {print sum}' result.csv)
echo "${total_baseline[*]}" | tr ' ' '\n' | awk '{printf("%.9f\n", $1)}' >total_baseline.csv
paste best_hot.csv total_baseline.csv | awk '{r=($1+0.01)/($2+0.01); printf("%.9f\n", r)}' >hot_ratio_to_total_baseline.csv
echo "${machine_baseline[*]}" | tr ' ' '\n' | awk '{printf("%.9f\n", $1)}' >machine_baseline.csv
paste best_hot.csv machine_baseline.csv | awk '{r=($1+0.01)/($2+0.01); printf("%.9f\n", r)}' >hot_ratio_to_machine_baseline.csv

echo -e "Doris version:\t$(head -n1 run.log)"
echo -e "Relative time(to total, geometric mean of column ratio_of_total):\t$total_score"
echo -e "Relative time(to machine, geometric mean of column ratio_of_machine):\t$machine_score"
echo -e "load time:\t$(cat loadtime) seconds"
echo -e "storage size:\t$(cat storage_size) bytes ($(echo "scale=3;$(cat storage_size)/1024/1024/1024" | bc) GB)"
echo -e "mechine:\t$(sudo dmidecode -s system-manufacturer), $(sudo dmidecode -s system-product-name)"
echo -e "column best:\t\t\tbest of hot1 and hot2"
echo -e "column total_baseline:\t\tdata from https://benchmark.clickhouse.com/"
echo -e "column ratio_of_total:\t\t(best+0.01)/(total_baseline+0.01)"
echo -e "column machine_baseline:\tdata from https://benchmark.clickhouse.com/, mechine is c6a.4xlarge,500gb gp2"
echo -e "column ratio_of_machine:\t(best+0.01)/(machine_baseline+0.01)"
echo
echo -e "query \tcold \thot1 \thot2 \tbest \ttotal_baseline \tratio_of_total \tmachine_baseline \tratio_of_machine"
paste result.csv best_hot.csv total_baseline.csv hot_ratio_to_total_baseline.csv machine_baseline.csv hot_ratio_to_machine_baseline.csv | tr ',' '\t'
echo -e "total\t${total_cold}\t${total_hot1}\t${total_hot2}\t${total_best_hot}"
rm -f best_hot.csv total_baseline.csv hot_ratio_to_total_baseline.csv machine_baseline.csv hot_ratio_to_machine_baseline.csv

echo -e "---------------------------------------------------------------------------------------------------"
./get-result-json.sh 1>>/dev/null
echo -e "$(python3 parse_clickbench_baseline.py)"
rm result.json
